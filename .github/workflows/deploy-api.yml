name: "Deploy Nest.js"

on:
  push:
    branches: [main, stage, develop, feat/deploy-google-cloud]
    # paths:
    #   - "apps/api/**"

  #WARN: Temporary permission
  workflow_dispatch:

env:
  GOOGLE_CLOUD_PROJECT_ID: ${{ secrets.GOOGLE_CLOUD_PROJECT_ID }}
  GOOGLE_CLOUD_PROJECT_NUMBER: ${{ secrets.GOOGLE_CLOUD_PROJECT_NUMBER }}
  GOOGLE_CLOUD_IDENTITY_POOL_ID: ${{ secrets.GOOGLE_CLOUD_IDENTITY_POOL_ID }}
  GOOGLE_CLOUD_IDENTITY_PROVIDER_ID: ${{ secrets.GOOGLE_CLOUD_IDENTITY_PROVIDER_ID }}

  MONGODB_USER_NAME: ${{ secrets.MONGODB_USER_NAME }}
  MONGODB_USER_PASSWORD: ${{ secrets.MONGODB_USER_PASSWORD }}
  MONGODB_HOST_NAME: ${{ secrets.MONGODB_HOST_NAME }}

jobs:
  prepare-api:
    name: Prepare
    uses: ./.github/workflows/prepare-deploy.yml
    with:
      trigger: ${{ github.event_name }}

  create-artifact-repository-api:
    name: Artifacts Repository
    permissions:
      id-token: write
      contents: read
    needs: prepare-api
    uses: ./.github/workflows/create-artifact-repository.yml
    with:
      repo_name: ${{ needs.prepare-api.outputs.repo_name_lowercase }}
      google_cloud_region: ${{ vars.GOOGLE_CLOUD_REGION }}
    secrets:
      google_cloud_project_id: ${{ secrets.GOOGLE_CLOUD_PROJECT_ID }}
      google_cloud_project_number: ${{ secrets.GOOGLE_CLOUD_PROJECT_NUMBER }}
      google_cloud_workload_identity_pool_id: ${{ secrets.GOOGLE_CLOUD_IDENTITY_POOL_ID }}
      google_cloud_workload_identity_provider_id: ${{ secrets.GOOGLE_CLOUD_IDENTITY_PROVIDER_ID }}
      google_cloud_service_account: ${{ needs.prepare-api.outputs.app_name }}-app-sa@${{ secrets.GOOGLE_CLOUD_PROJECT_ID }}.iam.gserviceaccount.com

  build-api:
    name: Docker
    permissions:
      id-token: write
      contents: read
    needs:
      - prepare-api
      - create-artifact-repository-api
    uses: ./.github/workflows/docker-build.yml
    with:
      repo_name: ${{ needs.prepare-api.outputs.repo_name_lowercase }}
      google_cloud_region: ${{ vars.GOOGLE_CLOUD_REGION }}
      google_cloud_service_env: ${{ github.event_name == 'push' && needs.prepare-api.outputs.environment || format('pre-{0}', needs.prepare-api.outputs.ref_name_lowercase) }}
      app: api
      app_version: ${{ needs.prepare-api.outputs.web_lowercase_version }}
    secrets:
      google_cloud_project_id: ${{ secrets.GOOGLE_CLOUD_PROJECT_ID }}
      google_cloud_project_number: ${{ secrets.GOOGLE_CLOUD_PROJECT_NUMBER }}
      google_cloud_workload_identity_pool_id: ${{ secrets.GOOGLE_CLOUD_IDENTITY_POOL_ID }}
      google_cloud_workload_identity_provider_id: ${{ secrets.GOOGLE_CLOUD_IDENTITY_PROVIDER_ID }}
      google_cloud_service_account: ${{ needs.prepare-api.outputs.app_name }}-app-sa@${{ secrets.GOOGLE_CLOUD_PROJECT_ID }}.iam.gserviceaccount.com

  deploy-api:
    name: CloudRun
    permissions:
      id-token: write
      contents: read
    needs:
      - prepare-api
      - build-api
    uses: ./.github/workflows/deploy-google-cloud-run.yml
    with:
      app_name: ${{ needs.prepare-api.outputs.app_name }}
      app: api
      environment: ${{ needs.prepare-api.outputs.environment }}
      ref_name: ${{ needs.prepare-api.outputs.ref_name_lowercase }}
      google_cloud_region: ${{ vars.GOOGLE_CLOUD_REGION }}
      google_cloud_service_env: ${{ github.event_name == 'push' && needs.prepare-api.outputs.environment || format('pre-{0}', needs.prepare-api.outputs.ref_name_lowercase) }}
    secrets:
      docker_image: ${{ needs.build-api.outputs.docker_image }}
      google_cloud_project_id: ${{ secrets.GOOGLE_CLOUD_PROJECT_ID }}
      google_cloud_project_number: ${{ secrets.GOOGLE_CLOUD_PROJECT_NUMBER }}
      google_cloud_workload_identity_pool_id: ${{ secrets.GOOGLE_CLOUD_IDENTITY_POOL_ID }}
      google_cloud_workload_identity_provider_id: ${{ secrets.GOOGLE_CLOUD_IDENTITY_PROVIDER_ID }}
      google_cloud_service_account: ${{ needs.prepare-api.outputs.app_name }}-app-sa@${{ secrets.GOOGLE_CLOUD_PROJECT_ID }}.iam.gserviceaccount.com
